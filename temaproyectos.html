<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Normalización - SQL Server</title>
    <style>
        /* ... (todo tu CSS original, sin cambios) ... */
        /* Puedes pegar tu bloque CSS original aquí */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (todo tu HTML original sin cambios, hasta el <script>) ... -->
        <!-- Puedes pegar aquí todo el HTML original hasta el script -->
    </div>

    <script>
        let currentPhase = 'analysis';
        let draggedElement = null;
        let normalizedTablesValid = false;
        let denormalizedTableValid = false;

        // Definir la estructura correcta para validación
        const correctNormalization = {
            estudiante: ['EstudianteID', 'NombreEstudiante', 'EmailEstudiante', 'CarreraEstudiante'],
            curso: ['CursoID', 'NombreCurso', 'Creditos', 'ProfesorID'],
            profesor: ['ProfesorID', 'NombreProfesor', 'DepartamentoProfesor'],
            matricula: ['EstudianteID', 'CursoID', 'FechaMatricula', 'NotaFinal', 'Semestre']
        };

        const correctDenormalization = [
            'EstudianteID', 'NombreEstudiante', 'CursoID', 'NombreCurso', 
            'ProfesorID', 'NombreProfesor', 'NotaFinal', 'Semestre'
        ];

        function showPhase(phase) {
            // Ocultar todas las fases
            document.querySelectorAll('.workspace').forEach(workspace => {
                workspace.classList.remove('active');
            });
            // Mostrar fase seleccionada
            document.getElementById(phase).classList.add('active');
            // Actualizar tabs
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            currentPhase = phase;
            updateProgressIndicator();
        }

        function updateProgressIndicator() {
            const steps = ['step1', 'step2', 'step3'];
            const phases = ['analysis', 'normalization', 'denormalization'];
            steps.forEach((step, index) => {
                const stepElement = document.getElementById(step);
                stepElement.classList.remove('current', 'completed');
                if (phases[index] === currentPhase) {
                    stepElement.classList.add('current');
                } else if (phases.indexOf(currentPhase) > index) {
                    stepElement.classList.add('completed');
                }
            });
        }

        function startNormalization() {
            showPhase('normalization');
            initializeNormalizationWorkspace();
        }

        function initializeNormalizationWorkspace() {
            const originalAttributes = document.getElementById('originalAttributes');
            const availableAttributes = document.getElementById('availableAttributes');
            // Limpiar área disponible
            availableAttributes.innerHTML = '';
            // Clonar atributos al área de trabajo
            const attributes = originalAttributes.querySelectorAll('.attribute');
            attributes.forEach(attr => {
                const cloned = attr.cloneNode(true);
                availableAttributes.appendChild(cloned);
            });
            setupDragAndDrop();
        }

        // ==== DRAG AND DROP CORREGIDO ====
        function setupDragAndDrop() {
            // Todas las zonas de destino
            document.querySelectorAll('.table-container[data-table-type]').forEach(zone => {
                zone.removeEventListener('dragover', dragOverHandler);
                zone.removeEventListener('dragenter', dragEnterHandler);
                zone.removeEventListener('dragleave', dragLeaveHandler);
                zone.removeEventListener('drop', dropHandler);
                zone.addEventListener('dragover', dragOverHandler);
                zone.addEventListener('dragenter', dragEnterHandler);
                zone.addEventListener('dragleave', dragLeaveHandler);
                zone.addEventListener('drop', dropHandler);
            });

            // Todos los atributos (en cualquier lado)
            document.querySelectorAll('.attribute').forEach(attr => {
                attr.setAttribute('draggable', true);
                attr.removeEventListener('dragstart', dragStartHandler);
                attr.removeEventListener('dragend', dragEndHandler);
                attr.addEventListener('dragstart', dragStartHandler);
                attr.addEventListener('dragend', dragEndHandler);
            });
        }
        function dragStartHandler(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function dragEndHandler(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }
        function dragOverHandler(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        function dragEnterHandler(e) {
            e.preventDefault();
            if (draggedElement) {
                this.classList.add('drop-zone');
            }
        }
        function dragLeaveHandler(e) {
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drop-zone');
            }
        }
        function dropHandler(e) {
            e.preventDefault();
            handleDrop(e, this);
        }

        function handleDrop(e, dropZone) {
            dropZone.classList.remove('drop-zone');
            if (!draggedElement) return;
            const tableType = dropZone.dataset.tableType;
            const attributeName = draggedElement.textContent.split('\n')[0].trim();
            if (validateAttributePlacement(attributeName, tableType)) {
                const attributesArea = dropZone.querySelector('.attributes-area');
                const placeholder = attributesArea.querySelector('.placeholder');
                if (placeholder) {
                    placeholder.remove();
                    attributesArea.classList.add('has-attributes');
                }
                attributesArea.appendChild(draggedElement); // <-- mueve el nodo (no clona)
                showFeedback('✅ ¡Correcto! ' + attributeName + ' pertenece a la tabla ' + tableType, 'success', 'normalizationFeedback');
                setupAttributeForRemoval(draggedElement, attributesArea);
                setupDragAndDrop(); // reactiva para el nuevo DOM
            } else {
                dropZone.classList.add('error');
                const expectedTable = draggedElement.dataset.table;
                showFeedback('❌ Error: ' + attributeName + ' no pertenece a la tabla ' + tableType + '. Pista: pertenece a ' + expectedTable, 'error', 'normalizationFeedback');
                setTimeout(() => {
                    dropZone.classList.remove('error');
                }, 1000);
            }
        }
        function setupAttributeForRemoval(attribute, parentArea) {
            attribute.ondblclick = function () {
                const availableArea = document.getElementById('availableAttributes');
                availableArea.appendChild(this);
                // Verificar si el área padre se queda vacía
                if ([...parentArea.children].filter(child => !child.classList.contains('placeholder')).length === 0) {
                    parentArea.classList.remove('has-attributes');
                    // Restaurar placeholder
                    const tableType = parentArea.closest('.table-container').dataset.tableType;
                    const placeholder = document.createElement('div');
                    placeholder.className = 'placeholder';
                    placeholder.textContent = {
                        'estudiante': 'Arrastra aquí los atributos de Estudiante',
                        'curso': 'Arrastra aquí los atributos de Curso',
                        'profesor': 'Arrastra aquí los atributos de Profesor',
                        'matricula': 'Arrastra aquí los atributos de Matrícula'
                    }[tableType] || 'Arrastra aquí los atributos';
                    parentArea.appendChild(placeholder);
                }
                showFeedback('Atributo devuelto al área disponible', 'warning', 'normalizationFeedback');
                setupDragAndDrop();
            };
        }

        // ==== RESTO DE TU JS ORIGINAL (sin cambios, puedes pegarlo aquí) ====
        // ... 
        // TODO: pega aquí el resto de tus funciones JS del código original (validaciones, generación SQL, etc)
        // ... 
        // Ejemplo:
        function validateAttributePlacement(attributeName, tableType) {
            return correctNormalization[tableType] && correctNormalization[tableType].includes(attributeName);
        }

        // ... resto de funciones (validateNormalization, generateSQL, etc.) igual a tu código original ...
        // ... (todo tu bloque de funciones después de setupAttributeForRemoval) ...
        // ... puedes pegar aquí desde "function validateNormalization() {" en adelante ...

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressIndicator();
        });
    </script>
</body>
</html>
